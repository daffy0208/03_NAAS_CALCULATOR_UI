<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Spreadsheet Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .upload-area { border: 2px dashed #ccc; padding: 40px; text-align: center; margin-bottom: 20px; border-radius: 8px; }
        .upload-area.dragover { border-color: #007bff; background: #f8f9fa; }
        .sheet-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .sheet-card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #f9f9f9; }
        .sheet-card h3 { margin: 0 0 10px 0; color: #333; }
        .sheet-card p { margin: 5px 0; color: #666; font-size: 14px; }
        .formula-analysis { background: #e8f4f8; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .formula-analysis h4 { margin: 0 0 10px 0; color: #0066cc; }
        .formula-analysis pre { background: #f0f0f0; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .comparison-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .comparison-table th, .comparison-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .comparison-table th { background: #f8f9fa; font-weight: bold; }
        .missing { background: #ffebee; color: #c62828; }
        .implemented { background: #e8f5e8; color: #2e7d32; }
        .partial { background: #fff3e0; color: #ef6c00; }
        .analysis-section { margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .analysis-section h2 { margin: 0 0 15px 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .calculation-details { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .calculation-details h4 { margin: 0 0 10px 0; color: #495057; }
        .calculation-details code { background: #e9ecef; padding: 2px 6px; border-radius: 3px; font-size: 12px; }
        .recommendations { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .recommendations h3 { margin: 0 0 10px 0; color: #856404; }
        .recommendations ul { margin: 10px 0; padding-left: 20px; }
        .recommendations li { margin: 5px 0; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Deep Spreadsheet Analysis Tool</h1>
        <p>Upload the original NaaS & Support costing sheet to perform a comprehensive analysis and comparison with the web app.</p>
        
        <div class="upload-area" id="uploadArea">
            <p>üìÅ Drag and drop the Excel file here or click to browse</p>
            <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
        </div>
        
        <div id="analysisResults" style="display: none;">
            <div class="analysis-section">
                <h2>üìä Spreadsheet Structure Analysis</h2>
                <div id="sheetStructure"></div>
            </div>
            
            <div class="analysis-section">
                <h2>üßÆ Calculation Engine Analysis</h2>
                <div id="calculationAnalysis"></div>
            </div>
            
            <div class="analysis-section">
                <h2>‚öñÔ∏è Web App vs Spreadsheet Comparison</h2>
                <div id="comparisonAnalysis"></div>
            </div>
            
            <div class="analysis-section">
                <h2>üîß Missing Features & Recommendations</h2>
                <div id="recommendations"></div>
            </div>
        </div>
    </div>

    <script>
        let workbook = null;
        let analysisData = {};

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const analysisResults = document.getElementById('analysisResults');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, { type: 'array' });
                    performDeepAnalysis();
                } catch (error) {
                    alert('Error reading file: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function performDeepAnalysis() {
            analysisData = {
                sheets: {},
                formulas: {},
                calculations: {},
                missingFeatures: [],
                recommendations: []
            };

            // Analyze each sheet
            workbook.SheetNames.forEach(sheetName => {
                const worksheet = workbook.Sheets[sheetName];
                const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                
                analysisData.sheets[sheetName] = {
                    data: sheetData,
                    formulas: extractFormulas(worksheet),
                    calculations: extractCalculations(sheetData),
                    structure: analyzeSheetStructure(sheetData)
                };
            });

            // Perform comprehensive analysis
            analyzeSheetStructure();
            analyzeCalculations();
            compareWithWebApp();
            generateRecommendations();
            
            displayResults();
        }

        function extractFormulas(worksheet) {
            const formulas = {};
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            
            for (let row = range.s.r; row <= range.e.r; row++) {
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                    const cell = worksheet[cellAddress];
                    
                    if (cell && cell.f) {
                        formulas[cellAddress] = {
                            formula: cell.f,
                            value: cell.v,
                            type: cell.t
                        };
                    }
                }
            }
            
            return formulas;
        }

        function extractCalculations(sheetData) {
            const calculations = [];
            
            // Look for calculation patterns
            sheetData.forEach((row, rowIndex) => {
                row.forEach((cell, colIndex) => {
                    if (typeof cell === 'string' && cell.includes('=')) {
                        calculations.push({
                            row: rowIndex + 1,
                            col: colIndex + 1,
                            formula: cell,
                            context: getCellContext(sheetData, rowIndex, colIndex)
                        });
                    }
                });
            });
            
            return calculations;
        }

        function getCellContext(sheetData, row, col) {
            const context = {
                above: row > 0 ? sheetData[row - 1][col] : '',
                below: row < sheetData.length - 1 ? sheetData[row + 1][col] : '',
                left: col > 0 ? sheetData[row][col - 1] : '',
                right: col < sheetData[row].length - 1 ? sheetData[row][col + 1] : ''
            };
            return context;
        }

        function analyzeSheetStructure(sheetData) {
            const structure = {
                headers: [],
                dataRows: 0,
                calculationRows: 0,
                totalRows: sheetData.length,
                hasFormulas: false
            };

            // Analyze first few rows for headers
            for (let i = 0; i < Math.min(5, sheetData.length); i++) {
                if (sheetData[i] && sheetData[i].length > 0) {
                    structure.headers.push(sheetData[i]);
                }
            }

            // Count data and calculation rows
            sheetData.forEach(row => {
                if (row && row.length > 0) {
                    structure.dataRows++;
                    if (row.some(cell => typeof cell === 'string' && cell.includes('='))) {
                        structure.calculationRows++;
                        structure.hasFormulas = true;
                    }
                }
            });

            return structure;
        }

        function analyzeCalculations() {
            const calculationTypes = {
                prtg: { formulas: [], patterns: [] },
                capital: { formulas: [], patterns: [] },
                support: { formulas: [], patterns: [] },
                onboarding: { formulas: [], patterns: [] },
                pbsFoundation: { formulas: [], patterns: [] },
                assessment: { formulas: [], patterns: [] },
                admin: { formulas: [], patterns: [] },
                otherCosts: { formulas: [], patterns: [] },
                enhancedSupport: { formulas: [], patterns: [] },
                dynamics: { formulas: [], patterns: [] },
                naas: { formulas: [], patterns: [] },
                discounts: { formulas: [], patterns: [] },
                totals: { formulas: [], patterns: [] }
            };

            // Analyze formulas by component type
            Object.keys(analysisData.sheets).forEach(sheetName => {
                const sheet = analysisData.sheets[sheetName];
                
                Object.keys(sheet.formulas).forEach(cellAddress => {
                    const formula = sheet.formulas[cellAddress];
                    const componentType = identifyComponentType(sheetName, formula.formula);
                    
                    if (componentType) {
                        calculationTypes[componentType].formulas.push({
                            sheet: sheetName,
                            cell: cellAddress,
                            formula: formula.formula,
                            value: formula.value
                        });
                    }
                });
            });

            analysisData.calculations = calculationTypes;
        }

        function identifyComponentType(sheetName, formula) {
            const sheetLower = sheetName.toLowerCase();
            const formulaLower = formula.toLowerCase();

            // Component type identification logic
            if (sheetLower.includes('prtg') || formulaLower.includes('prtg')) return 'prtg';
            if (sheetLower.includes('capital') || formulaLower.includes('equipment')) return 'capital';
            if (sheetLower.includes('support') && !sheetLower.includes('enhanced')) return 'support';
            if (sheetLower.includes('onboarding') || formulaLower.includes('onboarding')) return 'onboarding';
            if (sheetLower.includes('pbs') || sheetLower.includes('foundation')) return 'pbsFoundation';
            if (sheetLower.includes('assessment') || formulaLower.includes('assessment')) return 'assessment';
            if (sheetLower.includes('admin') || formulaLower.includes('admin')) return 'admin';
            if (sheetLower.includes('other') || formulaLower.includes('other')) return 'otherCosts';
            if (sheetLower.includes('enhanced') && sheetLower.includes('support')) return 'enhancedSupport';
            if (sheetLower.includes('dynamics') || formulaLower.includes('dynamics')) return 'dynamics';
            if (sheetLower.includes('naas') || formulaLower.includes('naas')) return 'naas';
            if (formulaLower.includes('discount') || formulaLower.includes('volume')) return 'discounts';
            if (formulaLower.includes('total') || formulaLower.includes('sum')) return 'totals';

            return null;
        }

        function compareWithWebApp() {
            const webAppComponents = [
                'help', 'prtg', 'capital', 'support', 'onboarding', 
                'pbsFoundation', 'assessment', 'admin', 'otherCosts', 
                'enhancedSupport', 'dynamics1Year', 'dynamics3Year', 
                'dynamics5Year', 'naasStandard', 'naasEnhanced'
            ];

            const spreadsheetComponents = Object.keys(analysisData.calculations);

            // Find missing components
            webAppComponents.forEach(component => {
                if (!spreadsheetComponents.includes(component)) {
                    analysisData.missingFeatures.push({
                        type: 'missing_component',
                        component: component,
                        description: `Component ${component} not found in spreadsheet`
                    });
                }
            });

            // Find spreadsheet components not in web app
            spreadsheetComponents.forEach(component => {
                if (!webAppComponents.includes(component)) {
                    analysisData.missingFeatures.push({
                        type: 'missing_webapp',
                        component: component,
                        description: `Spreadsheet component ${component} not implemented in web app`
                    });
                }
            });
        }

        function generateRecommendations() {
            const recommendations = [];

            // Analysis-based recommendations
            if (analysisData.missingFeatures.length > 0) {
                recommendations.push({
                    priority: 'high',
                    category: 'missing_features',
                    title: 'Implement Missing Components',
                    description: 'Add missing components found in spreadsheet',
                    details: analysisData.missingFeatures
                });
            }

            // Formula complexity analysis
            const complexFormulas = Object.values(analysisData.calculations)
                .flatMap(calc => calc.formulas)
                .filter(formula => formula.formula.length > 100);

            if (complexFormulas.length > 0) {
                recommendations.push({
                    priority: 'medium',
                    category: 'calculation_complexity',
                    title: 'Review Complex Calculations',
                    description: 'Some spreadsheet formulas are complex and may need verification',
                    details: complexFormulas
                });
            }

            // Sheet structure recommendations
            const sheetsWithManyFormulas = Object.keys(analysisData.sheets)
                .filter(sheet => Object.keys(analysisData.sheets[sheet].formulas).length > 20);

            if (sheetsWithManyFormulas.length > 0) {
                recommendations.push({
                    priority: 'medium',
                    category: 'sheet_complexity',
                    title: 'Complex Sheet Analysis',
                    description: 'Some sheets have many formulas that may need detailed review',
                    details: sheetsWithManyFormulas
                });
            }

            analysisData.recommendations = recommendations;
        }

        function displayResults() {
            displaySheetStructure();
            displayCalculationAnalysis();
            displayComparison();
            displayRecommendations();
            
            analysisResults.style.display = 'block';
        }

        function displaySheetStructure() {
            const container = document.getElementById('sheetStructure');
            let html = '<div class="sheet-list">';

            Object.keys(analysisData.sheets).forEach(sheetName => {
                const sheet = analysisData.sheets[sheetName];
                html += `
                    <div class="sheet-card">
                        <h3>üìÑ ${sheetName}</h3>
                        <p><strong>Total Rows:</strong> ${sheet.structure.totalRows}</p>
                        <p><strong>Data Rows:</strong> ${sheet.structure.dataRows}</p>
                        <p><strong>Calculation Rows:</strong> ${sheet.structure.calculationRows}</p>
                        <p><strong>Formulas:</strong> ${Object.keys(sheet.formulas).length}</p>
                        <p><strong>Has Complex Logic:</strong> ${sheet.structure.hasFormulas ? 'Yes' : 'No'}</p>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function displayCalculationAnalysis() {
            const container = document.getElementById('calculationAnalysis');
            let html = '';

            Object.keys(analysisData.calculations).forEach(componentType => {
                const calc = analysisData.calculations[componentType];
                if (calc.formulas.length > 0) {
                    html += `
                        <div class="calculation-details">
                            <h4>üîß ${componentType.toUpperCase()} Calculations</h4>
                            <p><strong>Formulas Found:</strong> ${calc.formulas.length}</p>
                            <div class="formula-analysis">
                                <h4>Sample Formulas:</h4>
                                ${calc.formulas.slice(0, 3).map(formula => `
                                    <pre>${formula.sheet} - ${formula.cell}: ${formula.formula}</pre>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            container.innerHTML = html;
        }

        function displayComparison() {
            const container = document.getElementById('comparisonAnalysis');
            let html = `
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Component</th>
                            <th>Spreadsheet</th>
                            <th>Web App</th>
                            <th>Status</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const allComponents = new Set([
                ...Object.keys(analysisData.calculations),
                'help', 'prtg', 'capital', 'support', 'onboarding', 
                'pbsFoundation', 'assessment', 'admin', 'otherCosts', 
                'enhancedSupport', 'dynamics1Year', 'dynamics3Year', 
                'dynamics5Year', 'naasStandard', 'naasEnhanced'
            ]);

            allComponents.forEach(component => {
                const inSpreadsheet = analysisData.calculations[component] && analysisData.calculations[component].formulas.length > 0;
                const inWebApp = ['help', 'prtg', 'capital', 'support', 'onboarding', 
                    'pbsFoundation', 'assessment', 'admin', 'otherCosts', 
                    'enhancedSupport', 'dynamics1Year', 'dynamics3Year', 
                    'dynamics5Year', 'naasStandard', 'naasEnhanced'].includes(component);

                let status, statusClass, notes;
                if (inSpreadsheet && inWebApp) {
                    status = '‚úÖ Implemented';
                    statusClass = 'implemented';
                    notes = 'Both spreadsheet and web app have this component';
                } else if (inSpreadsheet && !inWebApp) {
                    status = '‚ùå Missing in Web App';
                    statusClass = 'missing';
                    notes = 'Found in spreadsheet but not in web app';
                } else if (!inSpreadsheet && inWebApp) {
                    status = '‚ö†Ô∏è Web App Only';
                    statusClass = 'partial';
                    notes = 'In web app but not found in spreadsheet';
                } else {
                    status = '‚ùì Unknown';
                    statusClass = '';
                    notes = 'Not found in either';
                }

                html += `
                    <tr class="${statusClass}">
                        <td><strong>${component}</strong></td>
                        <td>${inSpreadsheet ? '‚úÖ' : '‚ùå'}</td>
                        <td>${inWebApp ? '‚úÖ' : '‚ùå'}</td>
                        <td>${status}</td>
                        <td>${notes}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function displayRecommendations() {
            const container = document.getElementById('recommendations');
            let html = '';

            analysisData.recommendations.forEach(rec => {
                const priorityColor = rec.priority === 'high' ? '#dc3545' : rec.priority === 'medium' ? '#fd7e14' : '#28a745';
                html += `
                    <div class="recommendations">
                        <h3 style="color: ${priorityColor};">${rec.priority.toUpperCase()} PRIORITY: ${rec.title}</h3>
                        <p>${rec.description}</p>
                        <ul>
                            ${rec.details.map(detail => `<li>${typeof detail === 'string' ? detail : detail.description || detail.component}</li>`).join('')}
                        </ul>
                    </div>
                `;
            });

            container.innerHTML = html;
        }
    </script>
</body>
</html>
