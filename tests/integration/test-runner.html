<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NaaS Calculator - Data Persistence Test Runner</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .status {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status-running {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status-completed {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-failed {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            transition: width 0.3s ease;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
            margin-bottom: 20px;
        }
        .results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .result-panel {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
        }
        .result-panel h3 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .test-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .test-passed {
            background: #d4edda;
            color: #155724;
        }
        .test-failed {
            background: #f8d7da;
            color: #721c24;
        }
        .test-running {
            background: #fff3cd;
            color: #856404;
        }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
        }
        .recommendations {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
        .recommendations ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .error-details {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
        }
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            .results {
                grid-template-columns: 1fr;
            }
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Data Persistence Test Suite</h1>
            <p>Comprehensive testing of data storage, state management, and synchronization</p>
        </div>

        <div class="controls">
            <button id="runTests" class="btn btn-primary">‚ñ∂Ô∏è Run All Tests</button>
            <button id="clearData" class="btn btn-secondary">üóëÔ∏è Clear Test Data</button>
            <button id="exportReport" class="btn btn-success">üìÑ Export Report</button>
            <button id="showDetails" class="btn btn-secondary">üìã Toggle Details</button>
        </div>

        <div id="status" class="status" style="display: none;">
            Ready to run tests
        </div>

        <div id="progress" style="display: none;">
            <div class="progress">
                <div id="progressBar" class="progress-bar" style="width: 0%"></div>
            </div>
            <div id="progressText" style="text-align: center; margin-top: 10px;">
                Initializing tests...
            </div>
        </div>

        <div id="log" class="log" style="display: none;"></div>

        <div id="results" style="display: none;">
            <div class="summary-stats">
                <div class="stat-card">
                    <div id="totalTests" class="stat-value">-</div>
                    <div class="stat-label">Total Tests</div>
                </div>
                <div class="stat-card">
                    <div id="passedTests" class="stat-value">-</div>
                    <div class="stat-label">Passed</div>
                </div>
                <div class="stat-card">
                    <div id="failedTests" class="stat-value">-</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-card">
                    <div id="passRate" class="stat-value">-</div>
                    <div class="stat-label">Pass Rate</div>
                </div>
                <div class="stat-card">
                    <div id="duration" class="stat-value">-</div>
                    <div class="stat-label">Duration (ms)</div>
                </div>
                <div class="stat-card">
                    <div id="warnings" class="stat-value">-</div>
                    <div class="stat-label">Warnings</div>
                </div>
            </div>

            <div class="results">
                <div class="result-panel">
                    <h3>üìä Test Results</h3>
                    <div id="testList"></div>
                </div>
                <div class="result-panel">
                    <h3>‚ö†Ô∏è Issues Found</h3>
                    <div id="errorList"></div>
                </div>
            </div>

            <div id="recommendations" class="recommendations" style="display: none;">
                <h3>üí° Recommendations</h3>
                <ul id="recommendationsList"></ul>
            </div>
        </div>
    </div>

    <!-- Load required dependencies -->
    <script src="js/storage-manager.js"></script>
    <script src="js/data-store.js"></script>
    <script src="js/calculations.js"></script>
    <script src="tests/data-persistence-test.js"></script>

    <script>
        class TestRunner {
            constructor() {
                this.currentTest = null;
                this.testResults = null;
                this.showingDetails = false;
                this.bindEvents();
                this.checkDependencies();
            }

            bindEvents() {
                document.getElementById('runTests').addEventListener('click', () => this.runTests());
                document.getElementById('clearData').addEventListener('click', () => this.clearData());
                document.getElementById('exportReport').addEventListener('click', () => this.exportReport());
                document.getElementById('showDetails').addEventListener('click', () => this.toggleDetails());
            }

            checkDependencies() {
                const dependencies = [
                    { name: 'StorageManager', available: typeof StorageManager !== 'undefined' },
                    { name: 'QuoteDataStore', available: typeof QuoteDataStore !== 'undefined' },
                    { name: 'DataPersistenceTest', available: typeof DataPersistenceTest !== 'undefined' }
                ];

                const missing = dependencies.filter(dep => !dep.available);
                if (missing.length > 0) {
                    this.showStatus(`‚ùå Missing dependencies: ${missing.map(d => d.name).join(', ')}`, 'failed');
                } else {
                    this.showStatus('‚úÖ All dependencies loaded successfully', 'completed');
                    setTimeout(() => this.hideStatus(), 3000);
                }
            }

            async runTests() {
                const runButton = document.getElementById('runTests');
                const originalText = runButton.textContent;

                try {
                    runButton.disabled = true;
                    runButton.textContent = '‚è≥ Running Tests...';

                    this.showProgress();
                    this.showLog();
                    this.hideResults();

                    this.showStatus('üß™ Running comprehensive data persistence tests...', 'running');
                    this.logMessage('=== Starting Data Persistence Test Suite ===');
                    this.logMessage('Initializing test environment...');

                    // Create test instance with custom logging
                    const originalConsole = console.log;
                    const originalError = console.error;
                    const originalWarn = console.warn;

                    console.log = (message) => {
                        this.logMessage(message);
                        originalConsole(message);
                    };

                    console.error = (message) => {
                        this.logMessage(`ERROR: ${message}`, 'error');
                        originalError(message);
                    };

                    console.warn = (message) => {
                        this.logMessage(`WARN: ${message}`, 'warn');
                        originalWarn(message);
                    };

                    // Run the tests
                    this.currentTest = new DataPersistenceTest();

                    // Wait for tests to complete
                    await new Promise((resolve) => {
                        const checkCompletion = setInterval(() => {
                            if (window.dataTestReport) {
                                clearInterval(checkCompletion);
                                resolve();
                            }
                        }, 500);

                        // Timeout after 2 minutes
                        setTimeout(() => {
                            clearInterval(checkCompletion);
                            resolve();
                        }, 120000);
                    });

                    // Restore console
                    console.log = originalConsole;
                    console.error = originalError;
                    console.warn = originalWarn;

                    this.testResults = window.dataTestReport;

                    if (this.testResults) {
                        this.showResults();
                        this.hideProgress();

                        const status = this.testResults.summary.failed > 0 ? 'failed' : 'completed';
                        const message = status === 'failed'
                            ? `‚ùå Tests completed with ${this.testResults.summary.failed} failures`
                            : `‚úÖ All tests passed successfully!`;

                        this.showStatus(message, status);
                    } else {
                        throw new Error('Test results not available');
                    }

                } catch (error) {
                    console.error('Test runner error:', error);
                    this.logMessage(`ERROR: ${error.message}`, 'error');
                    this.showStatus(`‚ùå Test execution failed: ${error.message}`, 'failed');
                    this.hideProgress();
                } finally {
                    runButton.disabled = false;
                    runButton.textContent = originalText;
                }
            }

            showProgress() {
                document.getElementById('progress').style.display = 'block';

                // Simulate progress (since we can't track individual test progress easily)
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 5;
                    if (progress >= 95) {
                        progress = 95;
                        clearInterval(interval);
                    }

                    document.getElementById('progressBar').style.width = `${progress}%`;
                    document.getElementById('progressText').textContent =
                        `Running tests... ${Math.round(progress)}%`;
                }, 200);

                // Complete progress when tests finish
                setTimeout(() => {
                    clearInterval(interval);
                    document.getElementById('progressBar').style.width = '100%';
                    document.getElementById('progressText').textContent = 'Tests completed!';
                }, 30000);
            }

            hideProgress() {
                document.getElementById('progress').style.display = 'none';
            }

            showLog() {
                const logElement = document.getElementById('log');
                logElement.style.display = 'block';
                logElement.innerHTML = '';
            }

            logMessage(message, type = 'info') {
                const logElement = document.getElementById('log');
                const timestamp = new Date().toLocaleTimeString();
                const color = {
                    error: '#dc3545',
                    warn: '#ffc107',
                    info: '#333'
                }[type] || '#333';

                logElement.innerHTML += `
                    <div style="color: ${color}; margin-bottom: 2px;">
                        <span style="color: #666;">[${timestamp}]</span> ${message}
                    </div>
                `;

                logElement.scrollTop = logElement.scrollHeight;
            }

            showStatus(message, type) {
                const statusElement = document.getElementById('status');
                statusElement.textContent = message;
                statusElement.className = `status status-${type}`;
                statusElement.style.display = 'block';
            }

            hideStatus() {
                document.getElementById('status').style.display = 'none';
            }

            showResults() {
                if (!this.testResults) return;

                const resultsElement = document.getElementById('results');
                resultsElement.style.display = 'block';

                // Update summary stats
                document.getElementById('totalTests').textContent = this.testResults.summary.total;
                document.getElementById('passedTests').textContent = this.testResults.summary.passed;
                document.getElementById('failedTests').textContent = this.testResults.summary.failed;
                document.getElementById('passRate').textContent = this.testResults.summary.passRate;
                document.getElementById('duration').textContent = Math.round(this.testResults.summary.totalDuration);
                document.getElementById('warnings').textContent = this.testResults.warnings.length;

                // Show test list
                const testListElement = document.getElementById('testList');
                testListElement.innerHTML = this.testResults.tests.map(test => {
                    const statusClass = test.status === 'PASSED' ? 'test-passed' : 'test-failed';
                    const icon = test.status === 'PASSED' ? '‚úÖ' : '‚ùå';
                    const duration = test.duration ? `${Math.round(test.duration)}ms` : '-';

                    return `
                        <div class="test-item">
                            <span>${icon} ${test.name}</span>
                            <div>
                                <span class="test-status ${statusClass}">${test.status}</span>
                                <small style="margin-left: 8px; color: #666;">${duration}</small>
                            </div>
                        </div>
                        ${test.error && this.showingDetails ? `
                            <div class="error-details">
                                <strong>Error:</strong> ${test.error}
                            </div>
                        ` : ''}
                    `;
                }).join('');

                // Show error list
                const errorListElement = document.getElementById('errorList');
                if (this.testResults.errors.length > 0) {
                    errorListElement.innerHTML = this.testResults.errors.map(error => `
                        <div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-left: 3px solid #dc3545;">
                            <strong>${error.test}</strong><br>
                            <small style="color: #666;">${error.error.message}</small>
                        </div>
                    `).join('');
                } else {
                    errorListElement.innerHTML = '<div style="color: #28a745; text-align: center; padding: 20px;">üéâ No errors found!</div>';
                }

                // Show warnings
                if (this.testResults.warnings.length > 0) {
                    errorListElement.innerHTML += `
                        <div style="margin-top: 15px;">
                            <strong>‚ö†Ô∏è Warnings:</strong>
                            ${this.testResults.warnings.map(warning => `
                                <div style="margin: 5px 0; padding: 5px; background: #fff3cd; color: #856404; font-size: 12px;">
                                    ${warning}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                // Show recommendations
                const recommendationsElement = document.getElementById('recommendations');
                const recommendationsListElement = document.getElementById('recommendationsList');

                if (this.testResults.recommendations.length > 0) {
                    recommendationsElement.style.display = 'block';
                    recommendationsListElement.innerHTML = this.testResults.recommendations.map(rec =>
                        `<li>${rec}</li>`
                    ).join('');
                } else {
                    recommendationsElement.style.display = 'none';
                }
            }

            hideResults() {
                document.getElementById('results').style.display = 'none';
            }

            toggleDetails() {
                this.showingDetails = !this.showingDetails;
                const button = document.getElementById('showDetails');
                button.textContent = this.showingDetails ? 'üìã Hide Details' : 'üìã Show Details';

                if (this.testResults) {
                    this.showResults(); // Refresh to show/hide details
                }
            }

            async clearData() {
                if (confirm('‚ö†Ô∏è This will clear all test data and application data. Continue?')) {
                    try {
                        // Clear localStorage
                        const keys = Object.keys(localStorage);
                        keys.forEach(key => {
                            if (key.startsWith('naas_') || key.includes('test')) {
                                localStorage.removeItem(key);
                            }
                        });

                        // Clear IndexedDB if available
                        if (typeof StorageManager !== 'undefined') {
                            const storageManager = new StorageManager();
                            await storageManager.initialize();
                            await storageManager.cleanup({
                                quotesKeepDays: 0,
                                componentsKeepDays: 0,
                                historyKeepDays: 0
                            });
                        }

                        this.showStatus('‚úÖ All test data cleared successfully', 'completed');
                        this.hideResults();
                        this.testResults = null;

                        setTimeout(() => this.hideStatus(), 3000);

                    } catch (error) {
                        this.showStatus(`‚ùå Error clearing data: ${error.message}`, 'failed');
                    }
                }
            }

            exportReport() {
                if (!this.testResults) {
                    alert('‚ùå No test results to export. Run tests first.');
                    return;
                }

                try {
                    const reportData = {
                        ...this.testResults,
                        exportedAt: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        url: window.location.href
                    };

                    const blob = new Blob([JSON.stringify(reportData, null, 2)], {
                        type: 'application/json'
                    });

                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `naas-data-persistence-test-report-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    this.showStatus('üìÑ Test report exported successfully', 'completed');
                    setTimeout(() => this.hideStatus(), 3000);

                } catch (error) {
                    this.showStatus(`‚ùå Error exporting report: ${error.message}`, 'failed');
                }
            }
        }

        // Initialize test runner when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new TestRunner();
        });
    </script>
</body>
</html>