<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Data Integrity Test Suite</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .status-badges {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .content {
            padding: 40px;
        }

        .test-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn.success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .progress-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #495057;
        }

        .test-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .test-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .test-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .test-card.passed {
            border-color: #27ae60;
            background: linear-gradient(135deg, rgba(39,174,96,0.05) 0%, rgba(46,204,113,0.05) 100%);
        }

        .test-card.failed {
            border-color: #e74c3c;
            background: linear-gradient(135deg, rgba(231,76,60,0.05) 0%, rgba(192,57,43,0.05) 100%);
        }

        .test-card h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .test-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .test-icon.passed {
            background: #27ae60;
            color: white;
        }

        .test-icon.failed {
            background: #e74c3c;
            color: white;
        }

        .test-icon.running {
            background: #f39c12;
            color: white;
        }

        .test-details {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #6c757d;
        }

        .test-metrics {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .metric {
            background: rgba(102,126,234,0.1);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .summary-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 30px;
            margin-top: 40px;
            text-align: center;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .summary-card {
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            padding: 20px;
        }

        .summary-card h4 {
            font-size: 2.2rem;
            margin-bottom: 8px;
        }

        .summary-card p {
            opacity: 0.9;
            font-weight: 500;
        }

        .log-section {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px 0;
        }

        .log-entry.error {
            color: #e74c3c;
        }

        .log-entry.success {
            color: #2ecc71;
        }

        .log-entry.warning {
            color: #f39c12;
        }

        .log-entry.info {
            color: #3498db;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .content {
                padding: 20px;
            }

            .test-controls {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ Comprehensive Data Integrity Test Suite</h1>
            <p>Testing all data integrity, persistence, and synchronization scenarios</p>
            <div class="status-badges">
                <span class="badge" id="statusBadge">Ready to Start</span>
                <span class="badge" id="timeBadge">00:00</span>
                <span class="badge" id="testsBadge">0 Tests</span>
                <span class="badge" id="scoreBadge">Score: --</span>
            </div>
        </div>

        <div class="content">
            <div class="test-controls">
                <button class="btn" id="startTestsBtn" onclick="startComprehensiveTests()">
                    üöÄ Start All Tests
                </button>
                <button class="btn" id="runBasicBtn" onclick="runBasicTests()">
                    ‚ö° Run Basic Tests
                </button>
                <button class="btn" id="runStressBtn" onclick="runStressTests()">
                    üí™ Run Stress Tests
                </button>
                <button class="btn danger" id="stopTestsBtn" onclick="stopTests()" disabled>
                    ‚èπÔ∏è Stop Tests
                </button>
                <button class="btn success" id="exportResultsBtn" onclick="exportResults()" disabled>
                    üìä Export Results
                </button>
            </div>

            <div class="progress-section" id="progressSection" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Initializing tests...</div>
            </div>

            <div class="test-results" id="testResults"></div>

            <div class="summary-section" id="summarySection" style="display: none;">
                <h2>üìà Test Results Summary</h2>
                <div class="summary-grid">
                    <div class="summary-card">
                        <h4 id="totalTestsSummary">0</h4>
                        <p>Total Test Suites</p>
                    </div>
                    <div class="summary-card">
                        <h4 id="passedTestsSummary">0</h4>
                        <p>Passed</p>
                    </div>
                    <div class="summary-card">
                        <h4 id="failedTestsSummary">0</h4>
                        <p>Failed</p>
                    </div>
                    <div class="summary-card">
                        <h4 id="integrityScoreSummary">0</h4>
                        <p>Integrity Score</p>
                    </div>
                    <div class="summary-card">
                        <h4 id="durationSummary">0s</h4>
                        <p>Duration</p>
                    </div>
                    <div class="summary-card">
                        <h4 id="coverageSummary">0%</h4>
                        <p>Coverage</p>
                    </div>
                </div>

                <div style="margin-top: 25px;">
                    <h3>üéØ Key Findings</h3>
                    <div id="keyFindings" style="text-align: left; margin-top: 15px;"></div>
                </div>
            </div>

            <div class="log-section" id="logSection">
                <h3 style="margin-bottom: 15px;">üìã Test Log</h3>
                <div id="testLog">
                    <div class="log-entry info">Ready to start comprehensive data integrity testing...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include all the test scripts -->
    <script src="js/storage-manager.js"></script>
    <script src="js/data-store.js"></script>
    <script src="data-integrity-repair-mechanisms.js"></script>
    <script src="comprehensive-data-integrity-test.js"></script>
    <script src="additional-integrity-tests.js"></script>

    <script>
        let testRunner = null;
        let startTime = 0;
        let testInterval = null;
        let currentTestSuite = '';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;

            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateProgress(current, total, message) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const percentage = total > 0 ? Math.round((current / total) * 100) : 0;

            progressFill.style.width = percentage + '%';
            progressText.textContent = `${message} (${current}/${total}) - ${percentage}%`;
        }

        function updateBadges(status, tests = 0, score = '--') {
            document.getElementById('statusBadge').textContent = status;
            document.getElementById('testsBadge').textContent = `${tests} Tests`;
            document.getElementById('scoreBadge').textContent = `Score: ${score}`;

            if (testInterval) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('timeBadge').textContent =
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        function createTestCard(testName, status = 'running', details = {}) {
            const card = document.createElement('div');
            card.className = `test-card ${status}`;
            card.id = `test-card-${testName.replace(/\s+/g, '-').toLowerCase()}`;

            const icon = status === 'passed' ? '‚úì' : status === 'failed' ? '‚úó' : '‚ö°';
            const iconClass = status === 'running' ? 'running' : status;

            card.innerHTML = `
                <h3>
                    <div class="test-icon ${iconClass}">${icon}</div>
                    ${testName}
                </h3>
                <div class="test-details" id="details-${testName.replace(/\s+/g, '-').toLowerCase()}">
                    ${status === 'running' ? 'Running tests...' : 'Completed'}
                </div>
                <div class="test-metrics" id="metrics-${testName.replace(/\s+/g, '-').toLowerCase()}">
                    ${details.metrics ? details.metrics.map(m => `<span class="metric">${m}</span>`).join('') : ''}
                </div>
            `;

            return card;
        }

        function updateTestCard(testName, status, result) {
            const cardId = `test-card-${testName.replace(/\s+/g, '-').toLowerCase()}`;
            const card = document.getElementById(cardId);

            if (card) {
                const icon = card.querySelector('.test-icon');
                const details = card.querySelector('.test-details');
                const metrics = card.querySelector('.test-metrics');

                card.className = `test-card ${status}`;
                icon.className = `test-icon ${status}`;
                icon.textContent = status === 'passed' ? '‚úì' : '‚úó';

                if (result) {
                    if (status === 'passed') {
                        details.innerHTML = `
                            <strong>‚úÖ All checks passed</strong><br>
                            ${result.summary || 'Test completed successfully'}
                        `;
                    } else {
                        details.innerHTML = `
                            <strong>‚ùå Test failed</strong><br>
                            ${result.error || result.summary || 'Test encountered errors'}
                        `;
                    }

                    if (result.metrics) {
                        metrics.innerHTML = result.metrics.map(m => `<span class="metric">${m}</span>`).join('');
                    }
                }
            }
        }

        async function startComprehensiveTests() {
            log('üöÄ Starting comprehensive data integrity test suite...', 'info');

            startTime = Date.now();
            testInterval = setInterval(() => updateBadges(currentTestSuite, 0, '--'), 1000);

            document.getElementById('startTestsBtn').disabled = true;
            document.getElementById('runBasicBtn').disabled = true;
            document.getElementById('runStressBtn').disabled = true;
            document.getElementById('stopTestsBtn').disabled = false;
            document.getElementById('progressSection').style.display = 'block';

            try {
                // Initialize test runner with custom event handlers
                testRunner = new window.ComprehensiveDataIntegrityTest();
                testRunner.onTestSuiteStart = (suiteName) => {
                    currentTestSuite = suiteName;
                    log(`‚ñ∂Ô∏è Starting: ${suiteName}`, 'info');

                    const card = createTestCard(suiteName, 'running');
                    document.getElementById('testResults').appendChild(card);

                    updateBadges(`Running: ${suiteName}`, 0, '--');
                };

                testRunner.onTestSuiteComplete = (suiteName, result) => {
                    const status = result.status === 'PASSED' ? 'passed' : 'failed';
                    log(`${status === 'passed' ? '‚úÖ' : '‚ùå'} ${suiteName}: ${result.status}`, status === 'passed' ? 'success' : 'error');

                    updateTestCard(suiteName, status, {
                        summary: result.result?.summary || result.error,
                        metrics: result.result?.metrics || []
                    });
                };

                testRunner.onTestProgress = (current, total, message) => {
                    updateProgress(current, total, message);
                };

                testRunner.onTestComplete = (finalResults) => {
                    onTestsComplete(finalResults);
                };

                // Override the test runner methods to add our event handling
                const originalRunAllTests = testRunner.runAllTests.bind(testRunner);
                testRunner.runAllTests = async function() {
                    const testSuites = [
                        { name: 'Data Corruption Pattern Tests', suite: () => this.runDataCorruptionTests() },
                        { name: 'Storage Systems Behavior Tests', suite: () => this.runStorageBehaviorTests() },
                        { name: 'Data Migration Tests', suite: () => this.runDataMigrationTests() },
                        { name: 'Concurrent Access Tests', suite: () => this.runConcurrentAccessTests() },
                        { name: 'Data Validation Tests', suite: () => this.runDataValidationTests() },
                        { name: 'Backup/Recovery Tests', suite: () => this.runBackupRecoveryTests() },
                        { name: 'Import/Export Accuracy Tests', suite: () => this.runImportExportTests() },
                        { name: 'Cross-Session Persistence Tests', suite: () => this.runCrossSessionTests() },
                        { name: 'Performance Tests', suite: () => this.runPerformanceTests() },
                        { name: 'Component State Sync Tests', suite: () => this.runComponentSyncTests() },
                        { name: 'Calculation Update Sync Tests', suite: () => this.runCalculationSyncTests() },
                        { name: 'Form State Persistence Tests', suite: () => this.runFormStateTests() },
                        { name: 'Multi-Tab Sync Tests', suite: () => this.runMultiTabSyncTests() },
                        { name: 'Data Integrity Repair Tests', suite: () => this.runDataRepairTests() },
                        { name: 'Memory Leak Detection Tests', suite: () => this.runMemoryLeakTests() },
                        { name: 'Error Boundary Tests', suite: () => this.runErrorBoundaryTests() },
                        { name: 'Security Vulnerability Tests', suite: () => this.runSecurityTests() }
                    ];

                    for (let i = 0; i < testSuites.length; i++) {
                        const { name, suite } = testSuites[i];

                        if (this.onTestSuiteStart) {
                            this.onTestSuiteStart(name);
                        }

                        if (this.onTestProgress) {
                            this.onTestProgress(i, testSuites.length, `Running ${name}`);
                        }

                        try {
                            const result = await this.runTestWithTimeout(suite, 10000);
                            this.testResults.push({
                                suite: name,
                                status: 'PASSED',
                                result: result,
                                timestamp: new Date().toISOString()
                            });

                            if (this.onTestSuiteComplete) {
                                this.onTestSuiteComplete(name, {
                                    status: 'PASSED',
                                    result: result
                                });
                            }
                        } catch (error) {
                            this.testResults.push({
                                suite: name,
                                status: 'FAILED',
                                error: error.message,
                                timestamp: new Date().toISOString()
                            });
                            this.errors.push({ suite: name, error: error });

                            if (this.onTestSuiteComplete) {
                                this.onTestSuiteComplete(name, {
                                    status: 'FAILED',
                                    error: error.message
                                });
                            }
                        }
                    }

                    const finalResults = this.generateComprehensiveReport();

                    if (this.onTestComplete) {
                        this.onTestComplete(finalResults);
                    }

                    return finalResults;
                };

            } catch (error) {
                log(`‚ùå Failed to initialize test suite: ${error.message}`, 'error');
                onTestsComplete(null, error);
            }
        }

        async function runBasicTests() {
            log('‚ö° Running basic integrity tests...', 'info');
            // Implementation for basic tests
            await startComprehensiveTests(); // For now, run all tests
        }

        async function runStressTests() {
            log('üí™ Running stress tests with large datasets...', 'info');
            // Implementation for stress tests
            await startComprehensiveTests(); // For now, run all tests
        }

        function stopTests() {
            log('‚èπÔ∏è Stopping tests...', 'warning');

            if (testInterval) {
                clearInterval(testInterval);
                testInterval = null;
            }

            if (testRunner) {
                // Stop the test runner if possible
                testRunner = null;
            }

            resetUI();
        }

        function resetUI() {
            document.getElementById('startTestsBtn').disabled = false;
            document.getElementById('runBasicBtn').disabled = false;
            document.getElementById('runStressBtn').disabled = false;
            document.getElementById('stopTestsBtn').disabled = true;

            updateBadges('Ready', 0, '--');
            currentTestSuite = '';
        }

        function onTestsComplete(results, error = null) {
            if (testInterval) {
                clearInterval(testInterval);
                testInterval = null;
            }

            if (error) {
                log(`‚ùå Tests failed: ${error.message}`, 'error');
                updateBadges('Failed', 0, '--');
                resetUI();
                return;
            }

            if (!results) {
                log('‚ùå No test results received', 'error');
                resetUI();
                return;
            }

            log(`‚úÖ All tests completed! Pass rate: ${results.summary.passRate}`, 'success');

            // Update badges
            updateBadges('Completed', results.summary.total, results.dataIntegrityScore);

            // Update progress
            updateProgress(results.summary.total, results.summary.total, 'All tests completed');

            // Show summary
            displaySummary(results);

            // Enable export
            document.getElementById('exportResultsBtn').disabled = false;

            resetUI();
        }

        function displaySummary(results) {
            const summarySection = document.getElementById('summarySection');
            summarySection.style.display = 'block';

            document.getElementById('totalTestsSummary').textContent = results.summary.total;
            document.getElementById('passedTestsSummary').textContent = results.summary.passed;
            document.getElementById('failedTestsSummary').textContent = results.summary.failed;
            document.getElementById('integrityScoreSummary').textContent = results.dataIntegrityScore + '/100';
            document.getElementById('durationSummary').textContent = Math.round(results.summary.duration / 1000) + 's';
            document.getElementById('coverageSummary').textContent = results.summary.passRate;

            // Display key findings
            const keyFindings = document.getElementById('keyFindings');
            if (results.recommendations && results.recommendations.length > 0) {
                keyFindings.innerHTML = results.recommendations.slice(0, 5).map(rec =>
                    `<div style="margin-bottom: 8px;">‚Ä¢ ${rec}</div>`
                ).join('');
            }
        }

        function exportResults() {
            if (!testRunner || !window.comprehensiveDataIntegrityResults) {
                log('‚ùå No test results to export', 'error');
                return;
            }

            const results = window.comprehensiveDataIntegrityResults;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `data-integrity-test-results-${timestamp}.json`;

            const blob = new Blob([JSON.stringify(results, null, 2)], {
                type: 'application/json'
            });

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);

            log(`üìä Results exported to ${filename}`, 'success');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            log('üéØ Comprehensive Data Integrity Test Suite loaded and ready', 'info');

            // Check if required classes are available
            if (typeof QuoteDataStore === 'undefined') {
                log('‚ö†Ô∏è QuoteDataStore not found - some tests may fail', 'warning');
            }

            if (typeof StorageManager === 'undefined') {
                log('‚ö†Ô∏è StorageManager not found - some tests may fail', 'warning');
            }

            if (typeof window.ComprehensiveDataIntegrityTest === 'undefined') {
                log('‚ùå ComprehensiveDataIntegrityTest not found - cannot run tests', 'error');
                document.getElementById('startTestsBtn').disabled = true;
                document.getElementById('runBasicBtn').disabled = true;
                document.getElementById('runStressBtn').disabled = true;
            } else {
                log('‚úÖ All test modules loaded successfully', 'success');
            }
        });
    </script>
</body>
</html>